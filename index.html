<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Eternal Hunt ‚Äî Backend Integrated</title>
<style>
:root{
  --bg:#05040a; --card:#0f1116; --muted:#98a0a6; --text:#eef0f6;
  --accent:#ff3b5c; --accent-2:#ff8a9b; --success:#2ecc71;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#02020a,#0b0b12);color:var(--text)}
.wrap{max-width:1100px;margin:18px auto;padding:18px}
.header{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#06060a}
h1{margin:0;font-size:20px}
.muted{color:var(--muted);font-size:13px}
.panel{margin-top:14px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.03);background:linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,.005))}
.panel-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;cursor:pointer}
.panel-body{padding:14px;display:block}
.row{display:flex;gap:8px;align-items:center}
.stat{background:rgba(255,255,255,0.02);padding:8px 10px;border-radius:8px;font-weight:700}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.btn{padding:10px 12px;border-radius:10px;border:0;background:#111;color:var(--text);cursor:pointer;font-weight:800;transition:transform .12s}
.btn:active{transform:scale(.98)}
.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#06060a;box-shadow:0 8px 30px rgba(255,59,92,.08)}
.ghost{background:transparent;border:1px solid rgba(255,255,255,.04)}
.log{margin-top:12px;padding:12px;border-radius:10px;background:#06060a;min-height:72px;border:1px solid rgba(255,255,255,.02);white-space:pre-wrap}
.small{font-size:13px;color:var(--muted)}
.shop-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px}
.codex-entry{opacity:0;transform:translateY(8px);animation:codexFade .6s forwards;margin-bottom:8px}
@keyframes codexFade{to{opacity:1;transform:none}}
.typing{border-right:2px solid var(--accent);white-space:nowrap;overflow:hidden;display:inline-block}
.glow{color:var(--accent);text-shadow:0 0 10px rgba(255,59,92,.12)}
.flash-green{animation:flashGreen .6s}
@keyframes flashGreen{0%{background:rgba(46,204,113,.12)}100%{background:transparent}}
.flash-red{animation:flashRed .6s}
@keyframes flashRed{0%{background:rgba(255,59,92,.12)}100%{background:transparent}}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:300}
.modal.open{display:flex}
.panel-compact{padding:8px}
@media(max-width:980px){.row{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="logo">EH</div>
    <div>
      <h1>üê∫ Eternal Hunt</h1>
      <div class="muted">Full game ‚Äî Firebase integrated (with local fallback)</div>
    </div>
  </div>

  <!-- Profile Panel (top) -->
  <div class="panel" id="profilePanel">
    <div class="panel-header">
      <div><strong>üë§ Profile Settings</strong></div>
      <div class="small">Set username and role (saved locally & to Firestore when available)</div>
    </div>
    <div class="panel-body panel-compact">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <div style="flex:1">
          <div class="small">Discord Username</div>
          <input id="usernameInput" placeholder="Wolf#1234" style="width:100%;padding:8px;border-radius:8px;border:0;background:#0b0b12;color:var(--text)"/>
        </div>
        <div style="width:160px">
          <div class="small">Role</div>
          <select id="roleSelect" style="width:100%;padding:8px;border-radius:8px;border:0;background:#0b0b12;color:var(--text)">
            <option value="wolf">Wolf üê∫</option>
            <option value="hunter">Hunter üèπ</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="primary" id="saveProfileBtn">Save Profile</button>
          <button class="btn ghost" id="resetBtn">Reset</button>
        </div>
      </div>
      <div style="margin-top:8px" class="small"><span id="backendStatus">Initializing backend...</span></div>
    </div>
  </div>

  <!-- Play Panel -->
  <div class="panel" id="playPanel">
    <div class="panel-header">
      <div><strong>üéÆ Play</strong></div>
      <div class="small">Hunt, Train, PvP, Daily, Rewarded Ads</div>
    </div>
    <div class="panel-body">
      <div class="row" id="topStats">
        <div class="stat">Name: <span id="displayName">‚Äî</span></div>
        <div class="stat">Role: <span id="displayRole">‚Äî</span></div>
        <div class="stat">L<span id="displayLevel">1</span></div>
        <div class="stat">STR <span id="displayStrength">1</span></div>
        <div class="stat">$PREY <span id="displayPrey">0</span></div>
      </div>

      <div class="controls">
        <button id="huntBtn" class="primary">ü¶å Hunt</button>
        <button id="trainBtn">üí™ Train (20 $PREY)</button>
        <button id="pvpBtn">‚öîÔ∏è Quick PvP</button>
        <button id="adBtn">üé• Watch Ad (+50 $PREY)</button>
        <button id="dailyBtn" class="ghost">‚òÄÔ∏è Daily +25</button>
        <button id="muteBtn" class="btn ghost">üîä</button>
      </div>

      <div id="mainLog" class="log">Welcome ‚Äî save profile to register on backend. Sound requires a click.</div>
    </div>
  </div>

  <!-- Quests Panel -->
  <div class="panel" id="questsPanel">
    <div class="panel-header">
      <div><strong>üìú Quests</strong></div>
      <div class="small">Complete quests to gain rewards & unlock codex</div>
    </div>
    <div class="panel-body">
      <div id="questsContainer" class="small"></div>
    </div>
  </div>

  <!-- Inventory & Shop Panel -->
  <div class="panel" id="shopPanel">
    <div class="panel-header">
      <div><strong>üéí Inventory & üõ° Shop</strong></div>
      <div class="small">Relics and shop</div>
    </div>
    <div class="panel-body">
      <strong>Inventory</strong>
      <div id="inventoryList" class="small" style="margin-top:8px">Empty</div>

      <div style="margin-top:12px"><strong>Relic Shop</strong></div>
      <div style="margin-top:8px" class="small" id="shopRows"></div>
      <div id="shopMessage" class="small" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Codex Panel -->
  <div class="panel" id="codexPanel">
    <div class="panel-header">
      <div><strong>üìñ Codex</strong></div>
      <div class="small">Lore entries unlocked with progress</div>
    </div>
    <div class="panel-body">
      <div id="codexBox" class="small">Complete quests to unlock codex lore.</div>
      <div style="margin-top:8px"><button id="openCodexBtn" class="btn ghost">Open Full Codex</button></div>
    </div>
  </div>

  <!-- Leaderboard Panel -->
  <div class="panel" id="leaderPanel">
    <div class="panel-header">
      <div><strong>üèÜ Leaderboard</strong></div>
      <div class="small">Local + Firestore (if available)</div>
    </div>
    <div class="panel-body">
      <ol id="leaderboardList" class="small"></ol>
      <div style="margin-top:8px" class="small">Tip: open the page on another browser/device and save profile to simulate other players.</div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="codexModal" class="modal"><div class="panel" style="width:92%;max-width:720px;padding:16px"><div style="display:flex;justify-content:space-between;align-items:center"><strong>Codex</strong><button id="closeCodexBtn" class="btn ghost">Close</button></div><div id="codexContent" style="margin-top:12px"></div></div></div>
<div id="adModal" class="modal"><div class="panel" style="width:92%;max-width:520px;padding:16px;text-align:center"><div style="display:flex;justify-content:space-between;align-items:center"><strong>Sponsored Reward</strong><button id="closeAdBtn" class="btn ghost">Cancel</button></div><div id="adBody" style="margin-top:12px" class="small center">Ad loading...</div></div></div>
<div id="pvpModal" class="modal"><div class="panel" style="width:92%;max-width:560px;padding:16px"><div style="display:flex;justify-content:space-between;align-items:center"><strong>PvP Arena</strong><button id="closePvpBtn" class="btn ghost">Close</button></div><div id="pvpContent" style="margin-top:12px"></div></div></div>

<!-- Sounds -->
<audio id="s_wolf" src="https://actions.google.com/sounds/v1/animals/wolf_howl.ogg"></audio>
<audio id="s_bow" src="https://actions.google.com/sounds/v1/foley/bow_pull_release.ogg"></audio>
<audio id="s_train" src="https://actions.google.com/sounds/v1/impacts/metal_thud.ogg"></audio>
<audio id="s_win" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="s_lose" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>
<audio id="s_ad" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<!-- Firebase + Game logic -->
<script type="module">
/* ============= Firebase init =============
   New Firebase config (from you) is used here.
   If Firestore cannot initialize, code falls back to localStorage.
*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBz11XDhnqNwMyNUjqFpoC8lppEgCP-mew",
  authDomain: "eternal-hunt-game-e48fb.firebaseapp.com",
  projectId: "eternal-hunt-game-e48fb",
  storageBucket: "eternal-hunt-game-e48fb.firebasestorage.app",
  messagingSenderId: "87971567607",
  appId: "1:87971567607:web:2b4401b8e8672436ea80f2"
};

let db = null;
let firebaseAvailable = false;
try {
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  firebaseAvailable = true;
  document.getElementById('backendStatus').textContent = 'Backend: Firestore connected';
} catch (err) {
  console.warn('Firestore init failed ‚Äî using local fallback', err);
  firebaseAvailable = false;
  document.getElementById('backendStatus').textContent = 'Backend: Firestore unavailable ‚Äî local fallback';
}

/* ============= Game state ============= */
const LOCAL_KEY = 'eh_state_v2';
let state = loadLocalState() || {
  username: '',
  role: 'wolf',
  prey: 0,
  strength: 1,
  level: 1,
  xp: 0,
  inventory: [],
  quests: null,
  codexUnlocked: []
};
let muted = false;
let adTimer = null;

/* ============= Role quests and codex pools ============= */
const WOLF_QUESTS = [
  {id:1,desc:"Hunt 3 times",goal:3,progress:0,reward:30,completed:false},
  {id:2,desc:"Train 3 times",goal:3,progress:0,reward:25,completed:false},
  {id:3,desc:"Win 2 PvP battles",goal:2,progress:0,reward:"Alpha Fang",completed:false},
  {id:4,desc:"Hunt 10 times",goal:10,progress:0,reward:60,completed:false},
  {id:5,desc:"Collect 150 $PREY",goal:150,progress:0,reward:100,completed:false},
  {id:6,desc:"Reach Strength 5",goal:5,progress:0,reward:80,completed:false},
  {id:7,desc:"Own 2 relics",goal:2,progress:0,reward:90,completed:false},
  {id:8,desc:"Win 5 PvP battles",goal:5,progress:0,reward:140,completed:false},
  {id:9,desc:"Hunt 30 times",goal:30,progress:0,reward:180,completed:false},
  {id:10,desc:"Complete Wolf questline",goal:9,progress:0,reward:300,completed:false}
];

const HUNTER_QUESTS = [
  {id:1,desc:"Hunt 4 times",goal:4,progress:0,reward:30,completed:false},
  {id:2,desc:"Train 4 times",goal:4,progress:0,reward:25,completed:false},
  {id:3,desc:"Win 2 PvP battles",goal:2,progress:0,reward:"Hunter's Bow",completed:false},
  {id:4,desc:"Hunt 12 times",goal:12,progress:0,reward:70,completed:false},
  {id:5,desc:"Collect 160 $PREY",goal:160,progress:0,reward:110,completed:false},
  {id:6,desc:"Reach Strength 5",goal:5,progress:0,reward:80,completed:false},
  {id:7,desc:"Own 1 relic",goal:1,progress:0,reward:70,completed:false},
  {id:8,desc:"Win 5 PvP battles",goal:5,progress:0,reward:140,completed:false},
  {id:9,desc:"Hunt 25 times",goal:25,progress:0,reward:160,completed:false},
  {id:10,desc:"Complete Hunter questline",goal:9,progress:0,reward:300,completed:false}
];

const WOLF_CODEX = [
  "The First Howl shook the skies when the Alpha rose.",
  "Under the Blood Moon, wolves gained strength beyond mortal limits.",
  "The Relics were crafted from the bones of fallen gods.",
  "The Totem of the Alpha binds the pack as one spirit.",
  "The Eternal Fang can slay even the undying.",
  "Whispers tell of a hidden Moon Temple deep in shadow forests.",
  "Loyal wolves who fall return as Spirits of the Eternal Hunt.",
  "Only the strongest Alpha may challenge the Eternal Alpha.",
  "The final prophecy: when Hunters fall, Wolves ascend eternal."
];

const HUNTER_CODEX = [
  "The first Hunters swore an oath under starlight.",
  "Silver arrows were forged to pierce the wolves‚Äô hide.",
  "The Order of the Hunt was founded to protect mankind.",
  "The Charm of Precision guided arrows through darkness.",
  "The Relic of Ancients once belonged to the First Hunter.",
  "The Cloak of the Eternal Hunt conceals the chosen.",
  "Hunters believe wolves carry fragments of cursed gods.",
  "To slay the Alpha is to claim the Hunt‚Äôs Crown.",
  "The final prophecy: when Wolves fall, Hunters reign eternal."
];

/* ============= Helpers ============= */
function sanitizeId(s){ return s.replace(/[.#$\/\[\]]/g,'_'); }
function loadLocalState(){ try{ return JSON.parse(localStorage.getItem(LOCAL_KEY)); }catch(e){return null;} }
function saveLocalState(){ localStorage.setItem(LOCAL_KEY, JSON.stringify(state)); }
function setMainLog(txt){ document.getElementById('mainLog').textContent = txt; }
function playSound(id){ if(muted) return; try{ const a=document.getElementById(id); if(a){ a.currentTime=0; a.play().catch(()=>{}); } }catch(e){} }
function flashMain(type){ const el=document.getElementById('mainLog'); if(type==='green'){ el.classList.add('flash-green'); setTimeout(()=>el.classList.remove('flash-green'),600);} else { el.classList.add('flash-red'); setTimeout(()=>el.classList.remove('flash-red'),600);} }

/* ============= Backend wrappers (Firestore with fallback) ============= */
async function saveToBackend(){
  saveLocalState();
  if(!state.username) return;
  if(firebaseAvailable && db){
    try{
      const id = sanitizeId(state.username);
      await setDoc(doc(db,'players',id), {
        username: state.username,
        role: state.role,
        prey: state.prey,
        strength: state.strength,
        level: state.level,
        xp: state.xp,
        inventory: state.inventory,
        updated: Date.now()
      });
      document.getElementById('backendStatus').textContent = 'Saved to Firestore';
      return;
    } catch(err){
      console.warn('Firestore write failed', err);
      document.getElementById('backendStatus').textContent = 'Firestore write failed ‚Äî using local';
    }
  }
  // Fallback: local leaderboard & local players store
  const players = JSON.parse(localStorage.getItem('eh_players_local_v1')||'{}');
  players[state.username] = { username: state.username, role: state.role, prey: state.prey, strength: state.strength, level: state.level, updated: Date.now() };
  localStorage.setItem('eh_players_local_v1', JSON.stringify(players));
  document.getElementById('backendStatus').textContent = 'Saved locally (fallback)';
}

async function loadFromBackend(username){
  // tries Firestore, falls back to local storage
  if(firebaseAvailable && db){
    try{
      const id = sanitizeId(username);
      const d = await getDoc(doc(db,'players',id));
      if(d.exists()){
        const data = d.data();
        // merge into state
        state.prey = data.prey || state.prey;
        state.strength = data.strength || state.strength;
        state.level = data.level || state.level;
        state.xp = data.xp || state.xp;
        state.inventory = data.inventory || state.inventory;
        state.role = data.role || state.role;
        saveLocalState();
        document.getElementById('backendStatus').textContent = 'Loaded from Firestore';
        return true;
      } else {
        document.getElementById('backendStatus').textContent = 'No remote profile found';
        return false;
      }
    } catch(err){
      console.warn('Firestore read failed', err);
      document.getElementById('backendStatus').textContent = 'Firestore read failed ‚Äî using local';
    }
  }
  // fallback
  const players = JSON.parse(localStorage.getItem('eh_players_local_v1')||'{}');
  if(players[username]) {
    const p = players[username];
    state.prey = p.prey || state.prey;
    state.strength = p.strength || state.strength;
    state.level = p.level || state.level;
    state.inventory = p.inventory || state.inventory;
    state.role = p.role || state.role;
    saveLocalState();
    document.getElementById('backendStatus').textContent = 'Loaded from local store';
    return true;
  }
  return false;
}

async function loadLeaderboardFromBackend(){
  const el = document.getElementById('leaderboardList'); el.innerHTML = '';
  if(firebaseAvailable && db){
    try{
      const q = query(collection(db,'players'), orderBy('prey','desc'), limit(20));
      const snap = await getDocs(q);
      snap.forEach(d => {
        const p = d.data();
        const li = document.createElement('li');
        li.textContent = `${p.username} ${p.role==='wolf'?'üê∫':'üèπ'} ‚Äî ${p.prey} $PREY (L${p.level} STR${p.strength})`;
        el.appendChild(li);
      });
      return;
    } catch(err){
      console.warn('Leaderboard read failed', err);
    }
  }
  // fallback: local players
  const players = JSON.parse(localStorage.getItem('eh_players_local_v1')||'{}');
  const arr = Object.values(players).sort((a,b)=>b.prey-a.prey).slice(0,20);
  arr.forEach(p=>{
    const li = document.createElement('li');
    li.textContent = `${p.username} ${p.role==='wolf'?'üê∫':'üèπ'} ‚Äî ${p.prey} $PREY (L${p.level} STR${p.strength})`;
    el.appendChild(li);
  });
}

/* ============= Game logic ============= */
function ensureQuests(){
  if(!state.quests || !Array.isArray(state.quests)){
    state.quests = (state.role === 'hunter') ? JSON.parse(JSON.stringify(HUNTER_QUESTS)) : JSON.parse(JSON.stringify(WOLF_QUESTS));
  }
}

function updateUI(){
  document.getElementById('displayName').textContent = state.username || '‚Äî';
  document.getElementById('displayRole').textContent = state.role;
  document.getElementById('displayPrey').textContent = state.prey;
  document.getElementById('displayStrength').textContent = state.strength;
  document.getElementById('displayLevel').textContent = state.level;
  renderQuests(); renderInventory(); renderCodexBox(); loadLeaderboardFromBackend();
}

function checkLevelUp(){
  while(state.xp >= state.level * 100){
    state.xp -= state.level * 100;
    state.level++;
    setMainLog(`Level up! You are now L${state.level}`);
  }
  saveLocalState();
}

/* Actions */
async function doHunt(){
  // require profile saved
  if(!state.username){ alert('Save profile first'); return; }
  const base = Math.floor(Math.random()*10)+6;
  const isBlood = Math.floor(Date.now()/60000)%4===0;
  const gained = isBlood ? base * 2 : base;
  state.prey += gained; state.xp += 12;
  setMainLog(`You hunted and gained ${gained} $PREY.${isBlood ? ' (Blood Moon!)' : ''}`);
  playSound(state.role === 'wolf' ? 's_wolf' : 's_bow');
  flashMain(gained >= 20 ? 'green' : 'red');
  incrementQuests('hunt');
  checkLevelUp();
  saveLocalState();
  await saveToBackend();
  updateUI();
}
async function doTrain(){
  if(!state.username){ alert('Save profile first'); return; }
  if(state.prey < 20){ setMainLog('Not enough $PREY to train'); playSound('s_lose'); return; }
  state.prey -= 20; state.strength += 1; state.xp += 8;
  setMainLog(`You trained. Strength now ${state.strength}`);
  playSound('s_train'); flashMain('green');
  incrementQuests('train'); checkLevelUp(); saveLocalState(); await saveToBackend(); updateUI();
}
async function doPvp(){
  if(!state.username){ alert('Save profile first'); return; }
  const enemy = { name: 'Rival'+Math.floor(Math.random()*90+10), strength: Math.max(1, state.strength + (Math.floor(Math.random()*3)-1))};
  const pRoll = Math.floor(Math.random()*20) + state.strength;
  const eRoll = Math.floor(Math.random()*20) + enemy.strength;
  if(pRoll >= eRoll){
    const reward = Math.ceil(10 + Math.random()*25);
    state.prey += reward; state.xp += 14;
    setMainLog(`Victory! You beat ${enemy.name} (STR ${enemy.strength}). +${reward} $PREY`);
    playSound('s_win'); incrementQuests('pvpwin');
  } else {
    const loss = Math.min(state.prey, Math.ceil(8 + Math.random()*18));
    state.prey -= loss; state.xp += 4;
    setMainLog(`Defeat... lost ${loss} $PREY to ${enemy.name} (STR ${enemy.strength}).`);
    playSound('s_lose'); incrementQuests('pvploss');
  }
  checkLevelUp(); saveLocalState(); await saveToBackend(); updateUI();
}

/* Quests */
function renderQuests(){
  ensureQuests();
  const el = document.getElementById('questsContainer'); el.innerHTML = '';
  state.quests.forEach(q=>{
    const d = document.createElement('div'); d.style.marginBottom = '8px';
    d.innerHTML = `<div style="font-weight:700">${q.desc}</div><div class="small">Progress ${q.progress||0}/${q.goal} ‚Ä¢ Reward: ${q.reward}</div>`;
    if(q.completed) d.style.opacity = '.6';
    el.appendChild(d);
  });
}

function incrementQuests(action){
  let anyCompleted = false;
  state.quests.forEach(q=>{
    if(q.completed) return;
    const text = q.desc.toLowerCase();
    if(action==='hunt' && text.includes('hunt')) q.progress = (q.progress||0)+1;
    if(action==='train' && text.includes('train')) q.progress = (q.progress||0)+1;
    if(action==='pvpwin' && text.includes('win')) q.progress = (q.progress||0)+1;
    if(action==='pvploss' && text.includes('survive')) q.progress = (q.progress||0)+1;
    if(action==='relic' && text.includes('own')) q.progress = state.inventory.length;
    if(text.includes('collect') && state.prey >= q.goal) q.progress = q.goal;
    if(text.includes('strength') && state.strength >= q.goal) q.progress = q.goal;
    if(text.includes('level') && state.level >= q.goal) q.progress = q.goal;

    if(q.progress >= q.goal && !q.completed){
      q.completed = true;
      if(typeof q.reward === 'number'){ state.prey += q.reward; setMainLog(`Quest "${q.desc}" complete: +${q.reward} $PREY`); }
      else { state.inventory.push(q.reward); setMainLog(`Quest "${q.desc}" complete: received ${q.reward}`); }
      anyCompleted = true;
    }
  });
  if(anyCompleted){ unlockCodex(); saveLocalState(); saveToBackend(); }
  renderQuests(); renderInventory();
}

/* Shop & Inventory */
function renderShop(){
  const shopRows = document.getElementById('shopRows'); shopRows.innerHTML = '';
  const items = [
    {name:'Alpha Fang', cost:120, role:'wolf'},
    {name:"Hunter's Bow", cost:120, role:'hunter'},
    {name:'Moon Totem', cost:160, role:'any'},
    {name:'Cloak of Shadows', cost:160, role:'any'}
  ];
  items.forEach(it=>{
    const div = document.createElement('div'); div.className='shop-row';
    const left = document.createElement('div'); left.textContent = `${it.name} ‚Äî ${it.cost} $PREY`;
    const right = document.createElement('div');
    const btn = document.createElement('button'); btn.textContent='Buy'; btn.className='btn';
    btn.onclick = ()=> buyRelic(it.name, it.cost);
    right.appendChild(btn);
    div.appendChild(left); div.appendChild(right);
    shopRows.appendChild(div);
  });
}

function renderInventory(){
  const el = document.getElementById('inventoryList'); el.innerHTML = state.inventory.length ? state.inventory.map(i=>'‚Ä¢ '+i).join('<br>') : '<span class="small">Empty</span>';
}

function buyRelic(name,cost){
  if(!state.username){ alert('Save profile first'); return; }
  if(state.prey < cost){ document.getElementById('shopMessage').textContent = 'Not enough $PREY.'; playSound('s_lose'); return; }
  state.prey -= cost; state.inventory.push(name);
  document.getElementById('shopMessage').textContent = `Bought ${name}.`;
  playSound('s_win'); incrementQuests('relic'); saveLocalState(); saveToBackend(); renderInventory(); renderQuests(); renderLeaderboard();
}

/* Codex */
function unlockCodex(){
  const pool = state.role === 'hunter' ? HUNTER_CODEX : WOLF_CODEX;
  if(state.codexUnlocked.length < pool.length){
    const next = pool[state.codexUnlocked.length];
    state.codexUnlocked.push(next);
    revealCodex(next);
    saveLocalState();
  }
}
function revealCodex(text){
  // show modal with typewriter
  const modal = document.getElementById('codexModal'); modal.classList.add('open');
  const content = document.getElementById('codexContent'); content.innerHTML = '';
  const p = document.createElement('p'); p.className = 'typing'; p.textContent = '';
  content.appendChild(p);
  let i = 0; const t = setInterval(()=>{ if(i<text.length){ p.textContent += text[i++]; } else { clearInterval(t); p.classList.remove('typing'); renderCodexBox(); } }, 34);
}
function renderCodexBox(){
  const box = document.getElementById('codexBox'); box.innerHTML = '';
  const pool = state.role === 'hunter' ? HUNTER_CODEX : WOLF_CODEX;
  if(state.codexUnlocked.length === 0){ box.innerHTML = '<div class="small">No lore unlocked yet. Complete quests to reveal codex.</div>'; return; }
  state.codexUnlocked.forEach((t,i)=>{ const p = document.createElement('p'); p.className='codex-entry glow'; p.textContent = `${i+1}. ${t}`; box.appendChild(p); });
}

/* Rewarded ad placeholder */
function startAd(){
  if(!state.username){ alert('Save profile first'); return; }
  const modal = document.getElementById('adModal'); modal.classList.add('open');
  const body = document.getElementById('adBody'); let sec = 5; body.textContent = `Watching ad... ${sec}s`;
  playSound('s_ad');
  adTimer = setInterval(()=>{ sec--; if(sec<=0){ clearInterval(adTimer); adTimer=null; state.prey += 50; saveLocalState(); saveToBackend(); renderInventory(); renderLeaderboard(); body.textContent='Ad finished: +50 $PREY'; setTimeout(()=>modal.classList.remove('open'),900); setMainLog('Ad: +50 $PREY'); } else body.textContent = `Watching ad... ${sec}s`; },1000);
}
function cancelAd(){ if(adTimer){ clearInterval(adTimer); adTimer=null; } document.getElementById('adModal').classList.remove('open'); }

/* Daily */
function claimDaily(){
  const key = 'eh_daily_ts_v2';
  const last = parseInt(localStorage.getItem(key) || '0',10);
  const now = Date.now();
  if(now - last < 24*3600*1000){ alert('Daily already claimed'); return; }
  state.prey += 25; localStorage.setItem(key, String(now)); saveLocalState(); saveToBackend(); updateUI(); setMainLog('Daily +25 $PREY');
}

/* Leaderboard UI uses loadLeaderboardFromBackend() defined above */

/* Save / Load profile */
async function saveProfileBtnHandler(){
  const name = document.getElementById('usernameInput').value.trim();
  const roleSel = document.getElementById('roleSelect').value;
  if(!name){ alert('Enter a Discord username (e.g. Wolf#1234)'); return; }
  const roleChanged = state.role !== roleSel;
  state.username = name; state.role = roleSel;
  if(roleChanged || !state.quests) state.quests = (state.role === 'hunter') ? JSON.parse(JSON.stringify(HUNTER_QUESTS)) : JSON.parse(JSON.stringify(WOLF_QUESTS));
  if(roleChanged) state.codexUnlocked = [];
  saveLocalState();
  await saveToBackend();
  setMainLog('Profile saved.');
  renderAll();
}
async function loadProfileAndSync(){
  const name = document.getElementById('usernameInput').value.trim();
  if(!name) return;
  state.username = name;
  const loaded = await loadFromBackend(name);
  // update role select if loaded role present
  document.getElementById('roleSelect').value = state.role;
  saveLocalState();
  renderAll();
}

/* PvP modal helpers */
function openPvpModal(){ document.getElementById('pvpModal').classList.add('open'); document.getElementById('pvpContent').textContent = 'Ready to fight.'; }
function closePvpModal(){ document.getElementById('pvpModal').classList.remove('open'); }

/* Codex modal helpers */
function openCodexModal(){ document.getElementById('codexModal').classList.add('open'); renderCodexModalContent(); }
function closeCodexModal(){ document.getElementById('codexModal').classList.remove('open'); }
function renderCodexModalContent(){
  const content = document.getElementById('codexContent'); content.innerHTML = '';
  if(state.codexUnlocked.length === 0){ content.innerHTML = '<div class="small">No lore unlocked yet.</div>'; return; }
  state.codexUnlocked.forEach((t,i)=>{ const p = document.createElement('p'); p.className='codex-entry'; p.textContent = `${i+1}. ${t}`; content.appendChild(p); });
}

/* Toggle mute */
function toggleMute(){ muted = !muted; document.getElementById('muteBtn').textContent = muted ? 'üîá' : 'üîä'; }

/* Render everything */
function renderAll(){
  ensureQuests();
  renderQuests(); renderInventory(); renderShop(); renderCodexBox(); updateUI();
}

/* ============= Event wiring ============= */
document.getElementById('saveProfileBtn').addEventListener('click', saveProfileBtnHandler);
document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('Reset local progress?')){ localStorage.removeItem(LOCAL_KEY); location.reload(); }});
document.getElementById('huntBtn').addEventListener('click', ()=>{ doHunt(); });
document.getElementById('trainBtn').addEventListener('click', ()=>{ doTrain(); });
document.getElementById('pvpBtn').addEventListener('click', ()=>{ openPvpModal(); });
document.getElementById('adBtn').addEventListener('click', ()=>{ startAd(); });
document.getElementById('dailyBtn').addEventListener('click', ()=>{ claimDaily(); });
document.getElementById('openCodexBtn').addEventListener('click', ()=> openCodexModal());
document.getElementById('closeCodexBtn').addEventListener('click', ()=> closeCodexModal());
document.getElementById('closeAdBtn').addEventListener('click', ()=> cancelAd());
document.getElementById('closePvpBtn').addEventListener('click', ()=> closePvpModal());
document.getElementById('muteBtn').addEventListener('click', ()=> toggleMute());

/* Quick play inside PvP modal */
document.getElementById('pvpContent').addEventListener('click',(e)=>{
  // if user clicks the panel body and there is no button, we still want a fight button: create inside on open
});
/* Provide actual PvP fight button */
function injectPvpFightButton(){
  const c = document.getElementById('pvpContent'); c.innerHTML = '<div class="small">Quick PvP ‚Äî press Fight</div><div style="margin-top:8px"><button class="primary" onclick="(async ()=>{ await doPvp(); document.getElementById(\'pvpContent\').textContent = document.getElementById(\'mainLog\').textContent; })()">Fight</button></div>';
}
document.getElementById('pvpBtn').addEventListener('click', ()=>{ openPvpModal(); injectPvpFightButton(); });

/* On page load */
(function start(){
  // if state has username prefed, show it
  document.getElementById('usernameInput').value = state.username || '';
  document.getElementById('roleSelect').value = state.role || 'wolf';
  renderAll();
  setMainLog('Ready. Save profile to register with backend (if available).');
})();
  
// expose functions used in inline strings
window.startAd = startAd;
window.buyRelic = buyRelic;
window.openCodexModal = openCodexModal;
window.closeCodexModal = closeCodexModal;
window.openPvpModal = openPvpModal;
window.closePvpModal = closePvpModal;
window.togglePanel = (id)=>{ document.getElementById(id).classList.toggle('open'); };
window.doHunt = doHunt;
window.doTrain = doTrain;
window.doPvp = doPvp;
window.toggleMute = toggleMute;

</script>
</body>
</html>
