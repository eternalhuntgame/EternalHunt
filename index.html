<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Eternal Hunt — Final</title>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Monetag Ads placeholder (zone) -->
<script src="https://a.monetag.com/9855091.js" data-cfasync="false" async></script>

<style>
:root{
  --bg:#05040a; --card:#0f1116; --muted:#98a0a6; --text:#eef0f6;
  --accent:#ff3b5c; --accent-2:#ff8a9b; --success:#2ecc71;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#02020a,#0b0b12);color:var(--text)}
.wrap{max-width:1100px;margin:18px auto;padding:18px}
.header{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#06060a}
h1{margin:0;font-size:20px}
.muted{color:var(--muted);font-size:13px}
.panel{margin-top:14px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.03);background:linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,.005))}
.panel-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;cursor:pointer}
.panel-body{padding:14px;display:block}
.row{display:flex;gap:8px;align-items:center}
.stat{background:rgba(255,255,255,0.02);padding:8px 10px;border-radius:8px;font-weight:700}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.btn{padding:10px 12px;border-radius:10px;border:0;background:#111;color:var(--text);cursor:pointer;font-weight:800;transition:transform .12s}
.btn:active{transform:scale(.98)}
.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#06060a;box-shadow:0 8px 30px rgba(255,59,92,.08)}
.ghost{background:transparent;border:1px solid rgba(255,255,255,.04)}
.log{margin-top:12px;padding:12px;border-radius:10px;background:#06060a;min-height:72px;border:1px solid rgba(255,255,255,.02);white-space:pre-wrap}
.small{font-size:13px;color:var(--muted)}
.shop-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px}
.codex-entry{opacity:0;transform:translateY(8px);animation:codexFade .6s forwards;margin-bottom:8px}
@keyframes codexFade{to{opacity:1;transform:none}}
.typing{border-right:2px solid var(--accent);white-space:nowrap;overflow:hidden;display:inline-block}
.glow{color:var(--accent);text-shadow:0 0 10px rgba(255,59,92,.12)}
.flash-green{animation:flashGreen .6s}
@keyframes flashGreen{0%{background:rgba(46,204,113,.12)}100%{background:transparent}}
.flash-red{animation:flashRed .6s}
@keyframes flashRed{0%{background:rgba(255,59,92,.12)}100%{background:transparent}}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:300}
.modal.open{display:flex}
.panel-compact{padding:8px}
@media(max-width:980px){.row{flex-direction:column;align-items:flex-start}}
.hidden{display:none}
.badge{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,.03);font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="logo">EH</div>
    <div>
      <h1>🐺 Eternal Hunt</h1>
      <div class="muted">Final build — Firestore + Monetag (local fallback)</div>
    </div>
  </div>

  <!-- Profile Panel (top) -->
  <div class="panel" id="profilePanel">
    <div class="panel-header">
      <div><strong>👤 Profile Settings</strong></div>
      <div class="small">Set username and role (saved locally & to Firestore when available)</div>
    </div>
    <div class="panel-body panel-compact">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <div style="flex:1">
          <div class="small">Discord Username</div>
          <input id="usernameInput" placeholder="Wolf#1234" style="width:100%;padding:8px;border-radius:8px;border:0;background:#0b0b12;color:var(--text)"/>
        </div>
        <div style="width:160px">
          <div class="small">Role</div>
          <select id="roleSelect" style="width:100%;padding:8px;border-radius:8px;border:0;background:#0b0b12;color:var(--text)">
            <option value="wolf">Wolf 🐺</option>
            <option value="hunter">Hunter 🏹</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="primary" id="saveProfileBtn">Save Profile</button>
          <button class="btn ghost" id="resetBtn">Reset</button>
        </div>
      </div>
      <div style="margin-top:8px" class="small"><span id="backendStatus">Initializing backend...</span></div>
    </div>
  </div>

  <!-- Play Panel -->
  <div class="panel" id="playPanel">
    <div class="panel-header">
      <div><strong>🎮 Play</strong></div>
      <div class="small">Hunt, Train, PvP, Daily, Rewarded Ads</div>
    </div>
    <div class="panel-body">
      <div class="row" id="topStats">
        <div class="stat">Name: <span id="displayName">—</span></div>
        <div class="stat">Role: <span id="displayRole">—</span></div>
        <div class="stat">L<span id="displayLevel">1</span></div>
        <div class="stat">STR <span id="displayStrength">1</span></div>
        <div class="stat">$PREY <span id="displayPrey">0</span></div>
        <div class="stat">Hunts <span id="displayHunts">0</span></div>
      </div>

      <div class="controls">
        <button id="huntBtn" class="primary">🦌 Hunt</button>
        <button id="trainBtn">💪 Train (20 $PREY)</button>
        <button id="pvpBtn">⚔️ Quick PvP</button>
        <button id="adBtn">🎥 Watch Ad (+50 $PREY)</button>
        <button id="dailyBtn" class="ghost">☀️ Daily +25</button>
        <button id="muteBtn" class="btn ghost">🔊</button>
      </div>

      <div id="dailyCountdown" class="small" style="margin-top:8px;color:#bbb"></div>

      <div id="mainLog" class="log">Welcome — save profile to register on backend. Sound requires a click.</div>
    </div>
  </div>

  <!-- Quests Panel -->
  <div class="panel" id="questsPanel">
    <div class="panel-header">
      <div><strong>📜 Quests</strong></div>
      <div class="small">Complete quests to gain rewards & unlock codex</div>
    </div>
    <div class="panel-body">
      <div id="questsContainer" class="small"></div>
    </div>
  </div>

  <!-- Inventory & Shop Panel -->
  <div class="panel" id="shopPanel">
    <div class="panel-header">
      <div><strong>🎒 Inventory & 🛡 Shop</strong></div>
      <div class="small">Relics and shop</div>
    </div>
    <div class="panel-body">
      <strong>Inventory</strong>
      <div id="inventoryList" class="small" style="margin-top:8px">Empty</div>

      <div style="margin-top:12px"><strong>Relic Shop</strong></div>
      <div style="margin-top:8px" class="small" id="shopRows"></div>
      <div id="shopMessage" class="small" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Codex Panel -->
  <div class="panel" id="codexPanel">
    <div class="panel-header">
      <div><strong>📖 Codex</strong></div>
      <div class="small">Lore entries unlocked with progress</div>
    </div>
    <div class="panel-body">
      <div id="codexBox" class="small">Complete quests to unlock codex lore.</div>
      <div style="margin-top:8px"><button id="openCodexBtn" class="btn ghost">Open Full Codex</button></div>
    </div>
  </div>

  <!-- Leaderboard Panel -->
  <div class="panel" id="leaderPanel">
    <div class="panel-header">
      <div><strong>🏆 Leaderboard</strong></div>
      <div class="small">Global + Local fallback</div>
    </div>
    <div class="panel-body">
      <ol id="leaderboardList" class="small"></ol>
      <div style="margin-top:8px" class="small">Tip: open the page on another browser/device and save profile to simulate other players.</div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="codexModal" class="modal"><div class="panel" style="width:92%;max-width:720px;padding:16px"><div style="display:flex;justify-content:space-between;align-items:center"><strong>Codex</strong><button id="closeCodexBtn" class="btn ghost">Close</button></div><div id="codexContent" style="margin-top:12px"></div></div></div>
<div id="adModal" class="modal"><div class="panel" style="width:92%;max-width:520px;padding:16px;text-align:center"><div style="display:flex;justify-content:space-between;align-items:center"><strong>Sponsored Reward</strong><button id="closeAdBtn" class="btn ghost">Cancel</button></div><div id="adBody" style="margin-top:12px" class="small center">Ad loading...</div></div></div>
<div id="pvpModal" class="modal"><div class="panel" style="width:92%;max-width:560px;padding:16px"><div style="display:flex;justify-content:space-between;align-items:center"><strong>PvP Arena</strong><button id="closePvpBtn" class="btn ghost">Close</button></div><div id="pvpContent" style="margin-top:12px"></div></div></div>

<!-- Sounds -->
<audio id="s_wolf" src="https://actions.google.com/sounds/v1/animals/wolf_howl.ogg"></audio>
<audio id="s_bow" src="https://actions.google.com/sounds/v1/foley/bow_pull_release.ogg"></audio>
<audio id="s_train" src="https://actions.google.com/sounds/v1/impacts/metal_thud.ogg"></audio>
<audio id="s_win" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="s_lose" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>
<audio id="s_ad" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
/* ========== FINAL GAME SCRIPT ========== */
/* User-provided Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBz11XDhnqNwMyNUjqFpoC8lppEgCP-mew",
  authDomain: "eternal-hunt-game-e48fb.firebaseapp.com",
  projectId: "eternal-hunt-game-e48fb",
  storageBucket: "eternal-hunt-game-e48fb.firebasestorage.app",
  messagingSenderId: "87971567607",
  appId: "1:87971567607:web:2b4401b8e8672436ea80f2"
};

/* Init Firebase safely */
let firebaseAvailable = false;
try {
  firebase.initializeApp(firebaseConfig);
  if(firebase && firebase.auth && firebase.firestore) firebaseAvailable = true;
} catch(e){ console.warn('Firebase init error', e); firebaseAvailable = false; }

/* Local state */
const LOCAL_KEY = 'eh_state_final_v2';
let state = {
  uid: null,
  username: '',
  role: 'wolf',
  prey: 0,
  strength: 1,
  level: 1,
  xp: 0,
  inventory: [],
  quests: null,
  codexUnlocked: [],
  huntsToday: 0,
  lastHuntDate: '',
  lastDailyReset: 0,
  updated: 0
};
let muted = false;
const DAILY_HUNT_LIMIT = 20;

/* Quests & codex pools */
const WOLF_QUESTS = [
  {id:1,desc:"Hunt 3 times",goal:3,progress:0,reward:30,completed:false},
  {id:2,desc:"Hunt rare prey 2 times",goal:2,progress:0,reward:75,completed:false},
  {id:3,desc:"Win 2 PvP battles",goal:2,progress:0,reward:"Alpha Fang",completed:false},
  {id:4,desc:"Train 3 times",goal:3,progress:0,reward:25,completed:false},
  {id:5,desc:"Collect 150 $PREY",goal:150,progress:0,reward:100,completed:false},
  {id:6,desc:"Reach Strength 5",goal:5,progress:0,reward:80,completed:false},
  {id:7,desc:"Own 2 relics",goal:2,progress:0,reward:90,completed:false},
  {id:8,desc:"Win 5 PvP battles",goal:5,progress:0,reward:140,completed:false},
  {id:9,desc:"Hunt 20 times",goal:20,progress:0,reward:160,completed:false},
  {id:10,desc:"Complete Wolf questline",goal:9,progress:0,reward:300,completed:false}
];
const HUNTER_QUESTS = [
  {id:1,desc:"Hunt 4 times",goal:4,progress:0,reward:30,completed:false},
  {id:2,desc:"Complete 3 hunts",goal:3,progress:0,reward:30,completed:false},
  {id:3,desc:"Win 2 PvP battles",goal:2,progress:0,reward:"Hunter's Bow",completed:false},
  {id:4,desc:"Train 4 times",goal:4,progress:0,reward:25,completed:false},
  {id:5,desc:"Collect 160 $PREY",goal:160,progress:0,reward:110,completed:false},
  {id:6,desc:"Reach Strength 5",goal:5,progress:0,reward:80,completed:false},
  {id:7,desc:"Own 1 relic",goal:1,progress:0,reward:70,completed:false},
  {id:8,desc:"Win 5 PvP battles",goal:5,progress:0,reward:150,completed:false},
  {id:9,desc:"Hunt 25 times",goal:25,progress:0,reward:160,completed:false},
  {id:10,desc:"Complete Hunter questline",goal:9,progress:0,reward:300,completed:false}
];
const WOLF_CODEX = [
  "The First Howl shook the skies when the Alpha rose.",
  "Under the Blood Moon, wolves gained strength beyond mortal limits.",
  "The Relics were crafted from the bones of fallen gods.",
  "The Totem of the Alpha binds the pack as one spirit.",
  "The Eternal Fang can slay even the undying.",
  "Whispers tell of a hidden Moon Temple deep in shadow forests.",
  "Loyal wolves who fall return as Spirits of the Eternal Hunt.",
  "Only the strongest Alpha may challenge the Eternal Alpha.",
  "The final prophecy: when Hunters fall, Wolves ascend eternal."
];
const HUNTER_CODEX = [
  "The first Hunters swore an oath under starlight.",
  "Silver arrows were forged to pierce the wolves’ hide.",
  "The Order of the Hunt was founded to protect mankind.",
  "The Charm of Precision guided arrows through darkness.",
  "The Relic of Ancients once belonged to the First Hunter.",
  "The Cloak of the Eternal Hunt conceals the chosen.",
  "Hunters believe wolves carry fragments of cursed gods.",
  "To slay the Alpha is to claim the Hunt’s Crown.",
  "The final prophecy: when Wolves fall, Hunters reign eternal."
];

/* Helpers */
function saveLocalState(){ try{ localStorage.setItem(LOCAL_KEY, JSON.stringify(state)); }catch(e){ console.warn('local save failed', e); } }
function loadLocalState(){ try{ const s = localStorage.getItem(LOCAL_KEY); if(s){ Object.assign(state, JSON.parse(s)); } }catch(e){ console.warn('local load failed', e); } }
function todayISO(){ return (new Date()).toISOString().split('T')[0]; }
function setMainLog(txt){ const el = document.getElementById('mainLog'); if(el) el.textContent = txt; }
function playSound(id){ if(muted) return; try{ const a = document.getElementById(id); if(a){ a.currentTime = 0; a.play().catch(()=>{}); } }catch(e){} }
function flashMain(type){ const el=document.getElementById('mainLog'); if(!el) return; if(type==='green'){ el.classList.add('flash-green'); setTimeout(()=>el.classList.remove('flash-green'),600);} else { el.classList.add('flash-red'); setTimeout(()=>el.classList.remove('flash-red'),600);} }

/* Firestore wrappers */
async function saveToBackend(){
  saveLocalState();
  if(!state.username) return;
  if(firebaseAvailable && state.uid){
    try{
      await firebase.firestore().collection('players').doc(state.uid).set({
        username: state.username,
        role: state.role,
        prey: state.prey,
        strength: state.strength,
        level: state.level,
        xp: state.xp,
        inventory: state.inventory,
        quests: state.quests,
        codexUnlocked: state.codexUnlocked,
        huntsToday: state.huntsToday,
        lastHuntDate: state.lastHuntDate,
        lastDailyReset: state.lastDailyReset,
        updated: Date.now()
      }, { merge: true });
      const t = document.getElementById('backendStatus'); if(t) t.textContent = 'Saved to Firestore';
      return;
    } catch(err){
      console.warn('Firestore write failed', err);
      const t = document.getElementById('backendStatus'); if(t) t.textContent = 'Firestore write failed — local';
    }
  }
  // fallback local players map
  try{
    const players = JSON.parse(localStorage.getItem('eh_players_local_final')||'{}');
    players[state.username] = { username: state.username, role: state.role, prey: state.prey, strength: state.strength, level: state.level, updated: Date.now() };
    localStorage.setItem('eh_players_local_final', JSON.stringify(players));
    const t = document.getElementById('backendStatus'); if(t) t.textContent = 'Saved locally (fallback)';
  }catch(e){}
}

async function loadLeaderboardFromBackend(){
  const el = document.getElementById('leaderboardList'); if(!el) return;
  el.innerHTML = '';
  if(firebaseAvailable){
    try{
      const snap = await firebase.firestore().collection('players').orderBy('prey','desc').limit(20).get();
      snap.forEach(d=>{
        const p = d.data();
        const li = document.createElement('li');
        li.textContent = `${p.username || 'Anon'} ${p.role==='wolf'?'🐺':'🏹'} — ${p.prey || 0} $PREY (L${p.level||1} STR${p.strength||1})`;
        el.appendChild(li);
      });
      return;
    }catch(e){
      console.warn('Leaderboard fetch failed', e);
    }
  }
  // local fallback
  try{
    const players = JSON.parse(localStorage.getItem('eh_players_local_final')||'{}');
    const arr = Object.values(players).sort((a,b)=> (b.prey||0)-(a.prey||0)).slice(0,20);
    arr.forEach(p=>{
      const li=document.createElement('li');
      li.textContent = `${p.username} — ${p.prey} $PREY`;
      el.appendChild(li);
    });
  }catch(e){}
}

/* Quests/codex ensure */
function ensureQuests(){
  if(!Array.isArray(state.quests) || state.quests.length === 0){
    state.quests = (state.role === 'hunter') ? JSON.parse(JSON.stringify(HUNTER_QUESTS)) : JSON.parse(JSON.stringify(WOLF_QUESTS));
  }
}

/* Daily reset */
function msUntilNextLocalMidnight(){
  const now = new Date();
  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0,0);
  return next.getTime() - now.getTime();
}
function performDailyRefresh(notify=true){
  state.lastDailyReset = Date.now();
  state.quests = (state.role === 'hunter') ? JSON.parse(JSON.stringify(HUNTER_QUESTS)) : JSON.parse(JSON.stringify(WOLF_QUESTS));
  state.codexUnlocked = [];
  state.huntsToday = 0;
  state.lastHuntDate = todayISO();
  try{ localStorage.removeItem('eh_daily_claim_v1'); }catch(e){}
  saveLocalState();
  saveToBackend().catch(()=>{});
  renderAll();
  if(notify) setMainLog('Daily refresh: quests & codex reset.');
}
let dailyResetTimeout = null;
let dailyCountdownInterval = null;
function scheduleDailyRefresh(){
  if(dailyResetTimeout) clearTimeout(dailyResetTimeout);
  if(dailyCountdownInterval) clearInterval(dailyCountdownInterval);
  const ms = msUntilNextLocalMidnight();
  dailyResetTimeout = setTimeout(()=>{ performDailyRefresh(true); scheduleDailyRefresh(); }, ms+200);
  dailyCountdownInterval = setInterval(()=>{
    const left = msUntilNextLocalMidnight();
    const h = Math.floor(left/(1000*60*60));
    const m = Math.floor((left%(1000*60*60))/(1000*60));
    const s = Math.floor((left%(1000*60))/1000);
    const el = document.getElementById('dailyCountdown');
    if(el) el.textContent = `Next reset in ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  },1000);
}

/* reset hunts by date */
function resetDailyHuntIfNeeded(){
  const today = todayISO();
  if(state.lastHuntDate !== today){
    state.huntsToday = 0;
    state.lastHuntDate = today;
    saveLocalState();
    try{ if(firebaseAvailable && state.uid) firebase.firestore().collection('players').doc(state.uid).update({ huntsToday: state.huntsToday, lastHuntDate: state.lastHuntDate }); }catch(e){}
  }
}

/* Blood Moon */
function isBloodMoon(){ return Math.floor(Date.now()/60000) % 4 === 0; }

/* Actions */
async function huntAction(){
  if(!state.username){ alert('Save profile first'); return; }
  resetDailyHuntIfNeeded();
  if(state.huntsToday >= DAILY_HUNT_LIMIT){ setMainLog("You've reached the daily hunt limit."); return; }
  const base = Math.floor(Math.random()*12)+6;
  const gained = isBloodMoon() ? base * 2 : base;
  state.prey += gained; state.xp += 12;
  state.huntsToday++; state.lastHuntDate = todayISO();
  setMainLog(`You hunted and gained ${gained} $PREY.${isBloodMoon() ? ' (Blood Moon!)' : ''}`);
  playSound(state.role === 'wolf' ? 's_wolf' : 's_bow');
  flashMain(gained>=20 ? 'green' : 'red');
  incrementQuests('hunt');
  checkLevelUp();
  await saveToBackend(); renderAll();
}
async function trainAction(){
  if(!state.username){ alert('Save profile first'); return; }
  if(state.prey < 20){ setMainLog('Not enough $PREY to train'); playSound('s_lose'); return; }
  state.prey -= 20; state.strength +=1; state.xp +=8;
  setMainLog(`You trained. Strength=${state.strength}`);
  playSound('s_train'); flashMain('green');
  incrementQuests('train'); checkLevelUp(); await saveToBackend(); renderAll();
}
async function pvpAction(){
  if(!state.username){ alert('Save profile first'); return; }
  const enemyStr = Math.floor(Math.random()*5)+1;
  const pRoll = Math.floor(Math.random()*20)+state.strength;
  const eRoll = Math.floor(Math.random()*20)+enemyStr;
  if(pRoll >= eRoll){
    const reward = Math.ceil(10 + Math.random()*30);
    state.prey += reward; state.xp += 14;
    setMainLog(`Victory! You beat Rival (STR ${enemyStr}). +${reward} $PREY`);
    playSound('s_win'); incrementQuests('pvpwin');
  } else {
    const loss = Math.min(state.prey, Math.ceil(8 + Math.random()*18));
    state.prey -= loss; state.xp += 4;
    setMainLog(`Defeat... lost ${loss} $PREY.`);
    playSound('s_lose'); incrementQuests('pvploss');
  }
  checkLevelUp(); await saveToBackend(); renderAll();
}

/* Quests */
function renderQuests(){
  ensureQuests();
  const el = document.getElementById('questsContainer'); if(!el) return; el.innerHTML='';
  state.quests.forEach(q=>{
    const d=document.createElement('div'); d.style.marginBottom='8px';
    d.innerHTML = `<div style="font-weight:700">${q.desc}</div><div class="small">Progress ${(q.progress||0)}/${q.goal} • Reward: ${q.reward}</div>`;
    if(q.completed) d.style.opacity='.6';
    el.appendChild(d);
  });
}
function incrementQuests(action){
  let any=false;
  state.quests.forEach(q=>{
    if(q.completed) return;
    const t = q.desc.toLowerCase();
    if(action==='hunt' && t.includes('hunt')) q.progress=(q.progress||0)+1;
    if(action==='train' && t.includes('train')) q.progress=(q.progress||0)+1;
    if(action==='pvpwin' && t.includes('win')) q.progress=(q.progress||0)+1;
    if(action==='pvploss' && t.includes('survive')) q.progress=(q.progress||0)+1;
    if(action==='relic' && t.includes('own')) q.progress = state.inventory.length;
    if(t.includes('collect') && state.prey >= q.goal) q.progress = q.goal;
    if(t.includes('strength') && state.strength >= q.goal) q.progress = q.goal;
    if(t.includes('level') && state.level >= q.goal) q.progress = q.goal;
    if(q.progress >= q.goal && !q.completed){
      q.completed = true;
      if(typeof q.reward === 'number'){ state.prey += q.reward; setMainLog(`Quest "${q.desc}" complete: +${q.reward} $PREY`); flashMain('green'); }
      else { state.inventory.push(q.reward); setMainLog(`Quest "${q.desc}" complete: received ${q.reward}`); flashMain('green'); }
      any = true;
    }
  });
  if(any){ unlockCodex(); saveLocalState(); saveToBackend(); }
  renderQuests(); renderInventory();
}

/* Shop & inventory */
function renderShop(){
  const rows=document.getElementById('shopRows'); if(!rows) return; rows.innerHTML='';
  const items=[
    {name:'Alpha Fang', cost:120, role:'wolf'},
    {name:"Hunter's Bow", cost:120, role:'hunter'},
    {name:'Moon Totem', cost:160, role:'any'},
    {name:'Cloak of Shadows', cost:160, role:'any'}
  ];
  items.forEach(it=>{
    const div=document.createElement('div'); div.className='shop-row';
    const left=document.createElement('div'); left.textContent = `${it.name} — ${it.cost} $PREY`;
    const right=document.createElement('div'); const btn=document.createElement('button'); btn.textContent='Buy'; btn.className='btn';
    btn.onclick = ()=> buyRelic(it.name, it.cost);
    right.appendChild(btn); div.appendChild(left); div.appendChild(right); rows.appendChild(div);
  });
}
function renderInventory(){
  const el=document.getElementById('inventoryList'); if(!el) return; el.innerHTML = state.inventory.length ? state.inventory.map(i=>'• '+i).join('<br>') : '<span class="small">Empty</span>';
}
function buyRelic(name,cost){
  if(!state.username){ alert('Save profile first'); return; }
  if(state.prey < cost){ document.getElementById('shopMessage') && (document.getElementById('shopMessage').textContent='Not enough $PREY.'); playSound('s_lose'); return; }
  state.prey -= cost; state.inventory.push(name);
  document.getElementById('shopMessage') && (document.getElementById('shopMessage').textContent = `Bought ${name}.`);
  playSound('s_win'); incrementQuests('relic'); saveLocalState(); saveToBackend(); renderInventory(); renderQuests(); loadLeaderboardFromBackend(); updateUI();
}

/* Codex */
function unlockCodex(){
  const pool = state.role === 'hunter' ? HUNTER_CODEX : WOLF_CODEX;
  if(state.codexUnlocked.length < pool.length){
    const next = pool[state.codexUnlocked.length];
    state.codexUnlocked.push(next);
    revealCodex(next);
    saveLocalState();
  }
}
function revealCodex(text){
  const modal=document.getElementById('codexModal');
  if(modal){
    modal.classList.add('open');
    const content=document.getElementById('codexContent'); content.innerHTML='';
    const p=document.createElement('p'); p.className='typing'; p.textContent='';
    content.appendChild(p);
    let i=0; const t=setInterval(()=>{ if(i<text.length){ p.textContent+=text[i++]; } else { clearInterval(t); p.classList.remove('typing'); renderCodexBox(); } },30);
  } else {
    state.codexUnlocked.push(text); renderCodexBox();
  }
}
function renderCodexBox(){
  const box=document.getElementById('codexBox'); if(!box) return; box.innerHTML='';
  const pool = state.role === 'hunter' ? HUNTER_CODEX : WOLF_CODEX;
  if(!state.codexUnlocked || state.codexUnlocked.length===0){ box.innerHTML = '<div class="small">No lore unlocked yet. Complete quests to reveal codex.</div>'; return; }
  state.codexUnlocked.forEach((t,i)=>{ const p=document.createElement('div'); p.className='codex-entry'; p.textContent = `${i+1}. ${t}`; box.appendChild(p); });
}

/* Ads (Monetag integration fallback) */
function showRewardedAd(){
  setMainLog('Loading ad...');
  try{
    if(window.Monetag && typeof Monetag.showInterstitial === 'function'){
      Monetag.showInterstitial({
        zoneId: "9855091",
        onClose: async ()=> {
          state.prey += 50; saveLocalState(); await saveToBackend(); renderInventory(); loadLeaderboardFromBackend(); setMainLog('Ad finished: +50 $PREY'); playSound('s_ad');
        },
        onError: (err)=> {
          console.warn('Monetag error', err);
          setMainLog('Ad failed. No reward.');
        }
      });
      return;
    }
    if(typeof invokeAd === 'function'){
      const onComplete = async ()=>{ state.prey += 50; await saveToBackend(); renderInventory(); loadLeaderboardFromBackend(); setMainLog('Ad complete: +50 $PREY'); document.removeEventListener('monetagAdComplete', onComplete); };
      document.addEventListener('monetagAdComplete', onComplete);
      invokeAd();
      return;
    }
    // fallback simulate for testing
    setMainLog('Ads not ready — simulating ad (test) ...');
    playSound('s_ad');
    setTimeout(async ()=>{
      state.prey += 50; await saveToBackend(); renderInventory(); loadLeaderboardFromBackend(); setMainLog('Simulated ad complete: +50 $PREY');
    },3000);
  }catch(e){
    console.error('Ad integration error', e);
    setMainLog('Ad error. Try later.');
  }
}
function cancelAd(){ document.getElementById('adModal') && document.getElementById('adModal').classList.remove('open'); }

/* Daily claim */
function claimDaily(){
  const key='eh_daily_claim_v1';
  const last = parseInt(localStorage.getItem(key)||'0',10);
  const now=Date.now();
  if(now - last < 24*3600*1000){ alert('Daily already claimed'); return; }
  state.prey += 25; localStorage.setItem(key, String(now)); saveLocalState(); saveToBackend(); updateUI(); setMainLog('Daily +25 $PREY');
}

/* Save profile (one time local-first) */
async function saveProfileHandler(){
  const nameEl=document.getElementById('usernameInput'); const roleEl=document.getElementById('roleSelect');
  const name = nameEl ? nameEl.value.trim() : '';
  const role = roleEl ? roleEl.value : 'wolf';
  if(!name){ alert('Enter a username (e.g. Wolf#1234)'); return; }
  // Save locally immediately so next load won't show panel
  state.username = name; state.role = role;
  state.quests = (state.role === 'hunter') ? JSON.parse(JSON.stringify(HUNTER_QUESTS)) : JSON.parse(JSON.stringify(WOLF_QUESTS));
  state.codexUnlocked = []; state.lastDailyReset = Date.now(); state.huntsToday = 0; state.lastHuntDate = todayISO();
  saveLocalState();
  // Try backend save (if auth exists)
  try{
    if(firebaseAvailable && firebase.auth().currentUser){
      state.uid = firebase.auth().currentUser.uid;
      await saveToBackend();
    } else {
      saveLocalState();
    }
  }catch(e){ console.warn('saveProfileHandler backend failed', e); saveLocalState(); }
  // Hide profile panel now (only first time)
  document.getElementById('profilePanel').style.display = 'none';
  renderAll(); setMainLog('Profile saved. Welcome ' + state.username + '!');
}

/* Init auth & load: check localStorage first so profile appears only once */
async function initAuthAndLoad(){
  // 1) If localStorage contains username => skip profile panel immediately
  loadLocalState(); // merges into state
  if(state.username){
    // hide profile immediately (first goal: don't ask again)
    try{ document.getElementById('profilePanel').style.display = 'none'; }catch(e){}
  }

  // 2) Initialize Firebase auth in background and try to load server copy (merge)
  if(firebaseAvailable){
    try{
      // Sign in anonymously if no current user
      if(!firebase.auth().currentUser) await firebase.auth().signInAnonymously();
      firebase.auth().onAuthStateChanged(async (user) => {
        if(user){
          state.uid = user.uid;
          // attempt to load remote doc -> merge (do not override local username if present)
          try{
            const doc = await firebase.firestore().collection('players').doc(state.uid).get();
            if(doc.exists){
              const remote = doc.data();
              // careful merge: keep local username if already set (local-first behavior), but use remote for other fields if local not present
              if(!state.username && remote.username) state.username = remote.username;
              // merge numeric/stats fields preferring remote if more recent
              if(remote.updated && (!state.updated || remote.updated > state.updated)){
                Object.assign(state, remote);
              } else {
                // keep local stats but ensure remote fields don't vanish
                state.inventory = state.inventory.length ? state.inventory : (remote.inventory || []);
                state.quests = state.quests && state.quests.length ? state.quests : (remote.quests || state.quests);
                state.codexUnlocked = state.codexUnlocked && state.codexUnlocked.length ? state.codexUnlocked : (remote.codexUnlocked || state.codexUnlocked);
              }
              state.updated = Date.now();
              saveLocalState();
            }
          }catch(e){ console.warn('Remote doc load failed', e); }
        }
        // make sure profile panel visibility follows local state
        if(state.username){
          document.getElementById('profilePanel').style.display = 'none';
        } else {
          document.getElementById('profilePanel').style.display = 'block';
        }
        // reflect inputs
        const nameEl=document.getElementById('usernameInput'); if(nameEl) nameEl.value = state.username || '';
        const roleEl=document.getElementById('roleSelect'); if(roleEl) roleEl.value = state.role || 'wolf';
        ensureQuests(); checkDailyReset(); resetDailyHuntIfNeeded(); renderAll(); scheduleDailyRefresh(); startLeaderboardPolling(); showPlayerRankIfPresent();
        setMainLog('Ready. Save profile only first time to register.');
      });
    }catch(err){
      console.warn('Auth/load error', err);
      // fallback keep local state
      if(state.username) document.getElementById('profilePanel').style.display='none';
      else document.getElementById('profilePanel').style.display='block';
      ensureQuests(); checkDailyReset(); resetDailyHuntIfNeeded(); renderAll(); scheduleDailyRefresh(); startLeaderboardPolling();
      setMainLog('Ready (offline).');
    }
  } else {
    // no firebase: rely on local
    if(state.username) document.getElementById('profilePanel').style.display='none';
    else document.getElementById('profilePanel').style.display='block';
    ensureQuests(); checkDailyReset(); resetDailyHuntIfNeeded(); renderAll(); scheduleDailyRefresh(); startLeaderboardPolling();
    setMainLog('Ready (offline).');
  }
}

/* UI update functions */
function updateUI(){
  const nameEl=document.getElementById('displayName'); if(nameEl) nameEl.textContent = state.username || '—';
  const roleEl=document.getElementById('displayRole'); if(roleEl) roleEl.textContent = state.role || '—';
  const levelEl=document.getElementById('displayLevel'); if(levelEl) levelEl.textContent = state.level || 1;
  const strEl=document.getElementById('displayStrength'); if(strEl) strEl.textContent = state.strength || 1;
  const preyEl=document.getElementById('displayPrey'); if(preyEl) preyEl.textContent = state.prey || 0;
  const huntsEl=document.getElementById('displayHunts'); if(huntsEl) huntsEl.textContent = (state.huntsToday||0) + '/' + DAILY_HUNT_LIMIT;
  renderQuests(); renderInventory(); renderShop(); renderCodexBox(); loadLeaderboardFromBackend();
}
function renderAll(){ ensureQuests(); renderQuests(); renderInventory(); renderShop(); renderCodexBox(); updateUI(); }

/* Leveling */
function checkLevelUp(){
  while(state.xp >= state.level * 100){
    state.xp -= state.level * 100;
    state.level++;
    setMainLog(`Level up! You are now L${state.level}`);
    flashMain('green');
  }
  saveLocalState();
}

/* Leaderboard polling & rank */
let leaderboardPollInterval = null;
const LEADERBOARD_POLL_SECONDS = 20;
function startLeaderboardPolling(){
  if(leaderboardPollInterval) clearInterval(leaderboardPollInterval);
  loadLeaderboardFromBackend().catch(()=>{});
  leaderboardPollInterval = setInterval(()=>{ loadLeaderboardFromBackend().catch(()=>{}); if(firebaseAvailable && state.uid){ firebase.firestore().collection('players').doc(state.uid).get().then(doc=>{ if(doc.exists){ Object.assign(state, doc.data()); saveLocalState(); renderAll(); } }).catch(()=>{}); } }, LEADERBOARD_POLL_SECONDS*1000);
}
async function getPlayerRank(){
  if(!firebaseAvailable || !state) return null;
  try{
    const snap = await firebase.firestore().collection('players').where('prey','>', state.prey).get();
    const better = snap.size || 0;
    return better + 1;
  }catch(e){ console.warn('getPlayerRank error', e); return null; }
}
async function showPlayerRankIfPresent(){
  const rank = await getPlayerRank().catch(()=>null);
  const elId='playerRankDisplay';
  let el=document.getElementById(elId);
  if(!el){
    const target=document.getElementById('topStats');
    if(target){ el=document.createElement('div'); el.id=elId; el.className='small'; el.style.marginTop='8px'; target.parentNode.insertBefore(el, target.nextSibling); }
  }
  if(el){ el.textContent = rank ? `Global rank: #${rank}` : ''; }
}

/* Wire events */
(function wireEvents(){
  const saveBtn=document.getElementById('saveProfileBtn'); if(saveBtn) saveBtn.addEventListener('click', saveProfileHandler);
  const resetBtn=document.getElementById('resetBtn'); if(resetBtn) resetBtn.addEventListener('click', ()=>{ if(confirm('Reset local progress?')){ localStorage.removeItem(LOCAL_KEY); localStorage.removeItem('eh_players_local_final'); location.reload(); }});
  const huntBtn=document.getElementById('huntBtn'); if(huntBtn) huntBtn.addEventListener('click', ()=> huntAction());
  const trainBtn=document.getElementById('trainBtn'); if(trainBtn) trainBtn.addEventListener('click', ()=> trainAction());
  const pvpBtn=document.getElementById('pvpBtn'); if(pvpBtn) pvpBtn.addEventListener('click', ()=> pvpAction());
  const adBtn=document.getElementById('adBtn'); if(adBtn) adBtn.addEventListener('click', ()=> showRewardedAd());
  const dailyBtn=document.getElementById('dailyBtn'); if(dailyBtn) dailyBtn.addEventListener('click', ()=> claimDaily());
  const openCodexBtn=document.getElementById('openCodexBtn'); if(openCodexBtn) openCodexBtn.addEventListener('click', ()=>{ document.getElementById('codexModal') && document.getElementById('codexModal').classList.add('open'); renderCodexModalContent(); });
  const closeCodexBtn=document.getElementById('closeCodexBtn'); if(closeCodexBtn) closeCodexBtn.addEventListener('click', ()=>{ document.getElementById('codexModal') && document.getElementById('codexModal').classList.remove('open'); });
  const closeAdBtn=document.getElementById('closeAdBtn'); if(closeAdBtn) closeAdBtn.addEventListener('click', ()=> cancelAd());
  const closePvpBtn=document.getElementById('closePvpBtn'); if(closePvpBtn) closePvpBtn.addEventListener('click', ()=> { document.getElementById('pvpModal') && document.getElementById('pvpModal').classList.remove('open'); });
  const muteBtn=document.getElementById('muteBtn'); if(muteBtn) muteBtn.addEventListener('click', ()=> { muted = !muted; muteBtn.textContent = muted ? '🔇' : '🔊'; });
  // PvP modal quick fight
  const pvpContent = document.getElementById('pvpContent');
  if(pvpContent){
    document.getElementById('pvpBtn') && document.getElementById('pvpBtn').addEventListener('click', ()=>{
      pvpContent.innerHTML = '<div class="small">Quick PvP — press Fight</div><div style="margin-top:8px"><button class="primary" id="fightNowBtn">Fight</button></div>';
      const fightBtn=document.getElementById('fightNowBtn'); if(fightBtn) fightBtn.addEventListener('click', async ()=>{ await pvpAction(); pvpContent.textContent = document.getElementById('mainLog').textContent; });
      document.getElementById('pvpModal') && document.getElementById('pvpModal').classList.add('open');
    });
  }
})();

/* Codex modal */
function renderCodexModalContent(){
  const content=document.getElementById('codexContent'); if(!content) return; content.innerHTML='';
  if(!state.codexUnlocked || state.codexUnlocked.length===0){ content.innerHTML='<div class="small">No lore unlocked yet.</div>'; return; }
  state.codexUnlocked.forEach((t,i)=>{ const p=document.createElement('p'); p.className='codex-entry'; p.textContent = `${i+1}. ${t}`; content.appendChild(p); });
}

/* boot */
(async function boot(){
  // load local first so profile appears only once
  loadLocalState();
  // if local username present -> hide profile immediately
  if(state.username){
    try{ document.getElementById('profilePanel').style.display = 'none'; }catch(e){}
  }
  // initialize auth + load remote (merge but local-first)
  await initAuthAndLoad();
})();
</script>
</body>
</html>
